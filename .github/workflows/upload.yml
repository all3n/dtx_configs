name: Upload Files to S3

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  upload:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check AWS CLI version
      run: aws --version
      
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/pip
          ~/.local/lib/python3.*/site-packages
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Configure AWS CLI for R2
      run: |
        # 手动配置 AWS CLI 用于 R2
        aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }} --profile r2
        aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }} --profile r2
        aws configure set region us-east-1 --profile r2
        
    - name: Make script executable
      run: chmod +x resources/upload.sh
      
    - name: Run upload script
      run: |
        cd ./resources
        python ./upload.py
      env:
        R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
